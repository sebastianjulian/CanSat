<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raspberry Pi Sensor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background-color: #f5f5f5;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
        }

        .timestamp {
            text-align: center;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .chart-container {
            background: #fff;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        canvas {
            width: 100% !important;
            height: 300px !important;
        }

        .no-data {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>üìä Raspberry Pi Sensor Dashboard</h1>
    <div class="timestamp" id="timestamp">Waiting for data...</div>
    <div id="charts"></div>

    <script>
        const chartRefs = {};

        async function fetchData() {
            try {
                const res = await fetch("/data");
                const json = await res.json();

                const chartDiv = document.getElementById("charts");
                const timestampDiv = document.getElementById("timestamp");
                chartDiv.innerHTML = ""; // Clear if new sensors are added dynamically

                if (!json || !json.history || !json.history["Elapsed [s]"].length) {
                    timestampDiv.textContent = "No data received yet.";
                    chartDiv.innerHTML = `<p class="no-data">No sensor data to display.</p>`;
                    return;
                }

                // Update timestamp
                timestampDiv.textContent = `Last updated: ${json.timestamp}`;

                const elapsed = json.history["Elapsed [s]"];

                for (const label in json.history) {
                    if (label === "Elapsed [s]") continue;

                    const yData = json.history[label];
                    const xData = elapsed;

                    if (!chartRefs[label]) {
                        // Create chart container
                        const container = document.createElement("div");
                        container.className = "chart-container";

                        const title = document.createElement("h3");
                        title.textContent = label;
                        container.appendChild(title);

                        const canvas = document.createElement("canvas");
                        canvas.id = label.replace(/\s+/g, "_");
                        container.appendChild(canvas);

                        chartDiv.appendChild(container);

                        chartRefs[label] = new Chart(canvas, {
                            type: "line",
                            data: {
                                labels: xData,
                                datasets: [{
                                    label: label,
                                    data: yData,
                                    borderColor: "rgb(54, 162, 235)",
                                    backgroundColor: "rgba(54, 162, 235, 0.1)",
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.3,
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: "Elapsed [s]"
                                        },
                                        type: "linear",
                                        beginAtZero: true
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: label
                                        },
                                        beginAtZero: false
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    } else {
                        chartRefs[label].data.labels = xData;
                        chartRefs[label].data.datasets[0].data = yData;
                        chartRefs[label].update();
                    }
                }

            } catch (err) {
                console.error("Error fetching data:", err);
                document.getElementById("timestamp").textContent = "‚ö†Ô∏è Error retrieving data.";
            }
        }

        fetchData();  // Initial load
        setInterval(fetchData, 1000);  // Update every second
    </script>
</body>
</html>
